"""
Molecular Hamiltonian Builder - QuantumForge V5 åˆ†å­å“ˆå¯†é¡¿é‡æ„å»ºå™¨

æ¥æ”¶åˆ†å­æ¨¡å‹å‚æ•°ï¼Œä½¿ç”¨PySCFé©±åŠ¨å™¨æ„å»ºåˆ†å­ç”µå­ç»“æ„å“ˆå¯†é¡¿é‡ã€‚
åŸºäºç¤ºä¾‹ä»£ç çš„åˆ†å­ç³»ç»Ÿå’Œå“ˆå¯†é¡¿é‡æ„å»ºåŠŸèƒ½ã€‚
"""

from typing import Dict, Any

# å¯¼å…¥åŸºç±»
try:
    from ..base_component import BaseComponent
except ImportError:
    import sys
    import os
    sys.path.append(os.path.dirname(os.path.dirname(os.path.dirname(__file__))))
    from components.base_component import BaseComponent


class MolecularHamiltonianBuilder(BaseComponent):
    """
    åˆ†å­å“ˆå¯†é¡¿é‡æ„å»ºå™¨
    
    åŠŸèƒ½ï¼šåŸºäºåˆ†å­å‚æ•°ç”Ÿæˆç”µå­ç»“æ„å“ˆå¯†é¡¿é‡æ„å»ºä»£ç 
    ä½¿ç”¨PySCFé©±åŠ¨å™¨å’ŒQiskit Natureè¿›è¡Œåˆ†å­å“ˆå¯†é¡¿é‡æ„å»º
    æ”¯æŒJordan-Wignerå’ŒBravyi-Kitaevé‡å­æ¯”ç‰¹æ˜ å°„
    """
    
    # LLMç†è§£çš„ç»„ä»¶æè¿°
    description = "Build molecular electronic structure Hamiltonian using PySCF driver and Qiskit Nature. Supports predefined molecules (H2, LiH, H2O, BeH2) and custom molecular geometries. Handles qubit mapping (Jordan-Wigner, Bravyi-Kitaev) for quantum molecular simulations."
    
    def execute(self, query: str, params: Dict[str, Any]) -> Dict[str, Any]:
        """
        æ‰§è¡Œåˆ†å­å“ˆå¯†é¡¿é‡æ„å»ºä»£ç ç”Ÿæˆ
        
        Args:
            query: ç”¨æˆ·åŸå§‹æŸ¥è¯¢
            params: åˆ†å­å‚æ•°ï¼ˆæ¥è‡ªMolecularModelGeneratorï¼‰
            
        Returns:
            Dict containing:
                - code: åˆ†å­å“ˆå¯†é¡¿é‡æ„å»ºPythonä»£ç 
                - notes: ä»£ç è¯´æ˜
        """
        # è·å–å‚æ•°
        atom = params.get("atom", "H 0 0 0; H 0 0 0.735")
        basis = params.get("basis", "sto-3g")
        charge = params.get("charge", 0)
        spin = params.get("spin", 0)
        
        # ç”Ÿæˆä»£ç 
        code = self._generate_molecular_hamiltonian_code(atom, basis, charge, spin)
        
        # ç”Ÿæˆè¯´æ˜
        notes = f"Molecular Hamiltonian builder: {basis} basis, charge={charge}, spin={spin}"
        
        return {"code": code, "notes": notes}
    
    def _generate_molecular_hamiltonian_code(self, atom: str, basis: str, charge: int, spin: int) -> str:
        """ç”Ÿæˆåˆ†å­å“ˆå¯†é¡¿é‡æ„å»ºä»£ç """
        
        code = f'''# Molecular Hamiltonian Builder - Generated by QuantumForge V5
from qiskit_nature.units import DistanceUnit
from qiskit_nature.second_q.drivers import PySCFDriver
from qiskit_nature.second_q.mappers import JordanWignerMapper, BravyiKitaevMapper
from qiskit_nature.second_q.transformers import ActiveSpaceTransformer

# Predefined molecules
MOLECULES = {{
    "H2": "H 0 0 0; H 0 0 0.735",
    "LiH": "Li 0 0 0; H 0 0 1.6", 
    "H2O": "O 0.0 0.0 0.0; H 0.757 0.586 0.0; H -0.757 0.586 0.0",
    "BeH2": "Be 0.0 0.0 0.0; H 0.0 0.0 1.3; H 0.0 0.0 -1.3"
}}

def create_molecular_problem(atom_string: str, basis: str = "sto-3g", charge: int = 0, spin: int = 0):
    """
    Create molecular problem using PySCF driver.
    
    Parameters:
    -----------
    atom_string : str
        Molecular geometry specification
    basis : str
        Basis set name (default: sto-3g)
    charge : int
        Total molecular charge (default: 0)
    spin : int
        Spin multiplicity (default: 0)
        
    Returns:
    --------
    ElectronicStructureProblem
        Molecular electronic structure problem
    """
    driver = PySCFDriver(
        atom=atom_string,
        basis=basis,
        charge=charge,
        spin=spin,
        unit=DistanceUnit.ANGSTROM,
    )
    
    problem = driver.run()
    return problem

def create_mapper(mapper_type: str = "jordan_wigner"):
    """
    Create qubit mapper for fermion-to-qubit transformation.
    
    Parameters:
    -----------
    mapper_type : str
        Type of mapper ("jordan_wigner" or "bravyi_kitaev")
        
    Returns:
    --------
    QubitMapper
        Qubit mapper instance
    """
    if mapper_type.lower() == "jordan_wigner":
        return JordanWignerMapper()
    elif mapper_type.lower() == "bravyi_kitaev":
        return BravyiKitaevMapper()
    else:
        return JordanWignerMapper()  # Default

def get_hamiltonian(problem, mapper):
    """
    Get qubit Hamiltonian from molecular problem.
    
    Parameters:
    -----------
    problem : ElectronicStructureProblem
        Molecular electronic structure problem
    mapper : QubitMapper
        Fermion-to-qubit mapper
        
    Returns:
    --------
    SparsePauliOp
        Qubit Hamiltonian as sparse Pauli operator
    """
    second_q_ops = problem.second_q_ops()
    hamiltonian = mapper.map(second_q_ops.get("ElectronicEnergy"))
    return hamiltonian

# Molecular parameters
atom = "{atom}"
basis = "{basis}"
charge = {charge}
spin = {spin}

# Create molecular problem
problem = create_molecular_problem(atom, basis, charge, spin)

# Create mapper (Jordan-Wigner by default)
mapper = create_mapper("jordan_wigner")

# Get qubit Hamiltonian
hamiltonian = get_hamiltonian(problem, mapper)

# Display information
print(f"Molecular system: {{atom}}")
print(f"Basis set: {{basis}}")
print(f"Charge: {{charge}}, Spin: {{spin}}")
print(f"Number of qubits: {{hamiltonian.num_qubits}}")
print(f"Number of Pauli terms: {{len(hamiltonian.paulis)}}")
'''
        
        return code


# æµ‹è¯•ä»£ç 
if __name__ == "__main__":
    print("ğŸ§ª Testing MolecularHamiltonianBuilder...")
    
    try:
        builder = MolecularHamiltonianBuilder()
        
        print(f"ğŸ“‹ Component: {builder.get_component_name()}")
        print(f"ğŸ“‹ Description: {builder.get_description()}")
        
        # æµ‹è¯•ç”¨ä¾‹ - åŸºäºç¤ºä¾‹ä»£ç çš„åˆ†å­ç³»ç»Ÿ
        test_cases = [
            {
                "name": "H2 molecule default",
                "query": "H2 molecule Hamiltonian",
                "params": {
                    "atom": "H 0 0 0; H 0 0 0.735",
                    "basis": "sto-3g",
                    "charge": 0,
                    "spin": 0
                }
            },
            {
                "name": "LiH molecule",
                "query": "LiH molecule electronic structure",
                "params": {
                    "atom": "Li 0 0 0; H 0 0 1.6",
                    "basis": "6-31g",
                    "charge": 0,
                    "spin": 0
                }
            },
            {
                "name": "H2O water molecule",
                "query": "Water molecule Hamiltonian",
                "params": {
                    "atom": "O 0.0 0.0 0.0; H 0.757 0.586 0.0; H -0.757 0.586 0.0",
                    "basis": "sto-3g",
                    "charge": 0,
                    "spin": 0
                }
            },
            {
                "name": "BeH2 molecule",
                "query": "BeH2 molecule construction",
                "params": {
                    "atom": "Be 0.0 0.0 0.0; H 0.0 0.0 1.3; H 0.0 0.0 -1.3",
                    "basis": "sto-3g",
                    "charge": 0,
                    "spin": 0
                }
            },
            {
                "name": "Charged H2+ ion",
                "query": "H2+ ion Hamiltonian",
                "params": {
                    "atom": "H 0 0 0; H 0 0 0.735",
                    "basis": "sto-3g",
                    "charge": 1,
                    "spin": 1
                }
            }
        ]
        
        for i, test_case in enumerate(test_cases, 1):
            print(f"\nğŸ§ª Test Case {i}: {test_case['name']}")
            print(f"  Query: \"{test_case['query']}\"")
            print(f"  Input params: {test_case['params']}")
            
            result = builder.execute(test_case['query'], test_case['params'])
            
            print(f"  âœ… Notes: {result['notes']}")
            print(f"  ğŸ“ Code length: {len(result['code'])} chars")
            
            # éªŒè¯ç”Ÿæˆçš„ä»£ç æ˜¯å¦åŒ…å«å…³é”®ç»„ä»¶
            code = result['code']
            assert "create_molecular_problem" in code
            assert "create_mapper" in code
            assert "get_hamiltonian" in code
            assert "PySCFDriver" in code
            assert "MOLECULES" in code
        
        print(f"\nâœ… All MolecularHamiltonianBuilder tests passed!")
        print(f"ğŸ¯ Component demonstrates molecular Hamiltonian features:")
        print(f"  â€¢ PySCF driver integration for electronic structure calculations")
        print(f"  â€¢ Predefined molecules (H2, LiH, H2O, BeH2) for quick setup")
        print(f"  â€¢ Flexible molecular geometry specification")
        print(f"  â€¢ Jordan-Wigner and Bravyi-Kitaev mapper support")
        print(f"  â€¢ Charge and spin state handling")
        print(f"  â€¢ Integration with Qiskit Nature molecular simulation")
        print(f"  â€¢ Compatible with QuantumForge V5 LLM-driven architecture")
        
    except Exception as e:
        print(f"âš ï¸ MolecularHamiltonianBuilder test error: {e}")
        import traceback
        traceback.print_exc()