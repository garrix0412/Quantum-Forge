"""
Heisenberg Hamiltonian Builder - QuantumForge V5

æ¥æ”¶å„å‘åŒæ€§Heisenbergæ¨¡å‹å‚æ•°ï¼Œç”ŸæˆQiskit SparsePauliOpå“ˆå¯†é¡¿é‡ä»£ç ã€‚
H = Jâˆ‘(Xáµ¢Xâ±¼ + Yáµ¢Yâ±¼ + Záµ¢Zâ±¼) + hâˆ‘Záµ¢
"""

from typing import Dict, Any, List, Tuple

# å¯¼å…¥åŸºç±»
try:
    from ..base_component import BaseComponent
except ImportError:
    import sys
    import os
    sys.path.append(os.path.dirname(os.path.dirname(os.path.dirname(__file__))))
    from components.base_component import BaseComponent


class HeisenbergHamiltonianBuilder(BaseComponent):
    """
    å„å‘åŒæ€§Heisenbergå“ˆå¯†é¡¿é‡æ„å»ºå™¨
    
    H = Jâˆ‘(Xáµ¢Xâ±¼ + Yáµ¢Yâ±¼ + Záµ¢Zâ±¼) + hâˆ‘Záµ¢
    
    å‚æ•°ï¼š
    - J: å„å‘åŒæ€§äº¤æ¢è€¦åˆå¼ºåº¦
    - h: çºµå‘ç£åœºå¼ºåº¦
    """
    
    description = "Build isotropic Heisenberg Hamiltonian Qiskit code. H = Jâˆ‘(XX + YY + ZZ) + hâˆ‘Z. Supports open/periodic boundary conditions for quantum spin chains."
    
    def execute(self, query: str, params: Dict[str, Any]) -> Dict[str, Any]:
        """ç”Ÿæˆå„å‘åŒæ€§Heisenbergå“ˆå¯†é¡¿é‡ä»£ç """
        # ç®€åŒ–å‚æ•°è·å–
        num_qubits = int(params.get("num_qubits", 4))
        J = float(params.get("J", 1.0))  # å„å‘åŒæ€§è€¦åˆå¼ºåº¦
        h = float(params.get("h", 0.0))  # çºµå‘ç£åœºå¼ºåº¦
        boundary = params.get("boundary_conditions", "open")
        
        # æ„å»ºå“ˆå¯†é¡¿é‡ä»£ç 
        code = self._generate_isotropic_heisenberg_code(num_qubits, J, h, boundary)
        
        # ç®€è¦æè¿°
        notes = f"Isotropic Heisenberg Hamiltonian: {num_qubits} qubits, J={J}, h={h}, {boundary} boundary"
        
        return {"code": code, "notes": notes}
    
    def _generate_isotropic_heisenberg_code(self, num_qubits: int, J: float, h: float, boundary: str) -> str:
        """ç”Ÿæˆå„å‘åŒæ€§Heisenbergå“ˆå¯†é¡¿é‡æ„å»ºä»£ç """
        
        code = f'''# Isotropic Heisenberg Hamiltonian Builder - Generated by QuantumForge V5
from qiskit.quantum_info import SparsePauliOp

def build_heisenberg_hamiltonian(num_qubits: int, J: float, h: float = 0.0, boundary: str = "open"):
    """
    Build isotropic Heisenberg Hamiltonian for quantum spin chain.
    
    H = J*âˆ‘(Xáµ¢Xâ±¼ + Yáµ¢Yâ±¼ + Záµ¢Zâ±¼) + h*âˆ‘Záµ¢
    
    Parameters:
    -----------
    num_qubits : int
        Number of qubits in the spin chain
    J : float
        Isotropic exchange coupling strength (Jx = Jy = Jz = J)
    h : float
        Longitudinal magnetic field strength (Z direction)
    boundary : str
        Boundary conditions ("open" or "periodic")
        
    Returns:
    --------
    SparsePauliOp
        Isotropic Heisenberg Hamiltonian as sparse Pauli operator
    """
    pauli_list = []
    
    # Exchange interaction terms (isotropic: J for all three directions)
    coupling_terms = num_qubits - 1 if boundary == "open" else num_qubits
    
    for i in range(coupling_terms):
        j = (i + 1) % num_qubits
        
        # XX interaction: J * Xáµ¢Xâ±¼
        pauli_string = ['I'] * num_qubits
        pauli_string[i] = 'X'
        pauli_string[j] = 'X'
        pauli_list.append((''.join(pauli_string), J))
        
        # YY interaction: J * Yáµ¢Yâ±¼
        pauli_string = ['I'] * num_qubits
        pauli_string[i] = 'Y'
        pauli_string[j] = 'Y'
        pauli_list.append((''.join(pauli_string), J))
        
        # ZZ interaction: J * Záµ¢Zâ±¼
        pauli_string = ['I'] * num_qubits
        pauli_string[i] = 'Z'
        pauli_string[j] = 'Z'
        pauli_list.append((''.join(pauli_string), J))
    
    # Longitudinal magnetic field terms: h * Záµ¢
    if abs(h) > 1e-12:
        for i in range(num_qubits):
            pauli_string = ['I'] * num_qubits
            pauli_string[i] = 'Z'
            pauli_list.append((''.join(pauli_string), h))
    
    return SparsePauliOp.from_list(pauli_list)

# Isotropic Heisenberg Model Parameters
num_qubits = {num_qubits}
J = {J}  # Isotropic exchange coupling (Jx = Jy = Jz = J)
h = {h}  # Longitudinal magnetic field
boundary = "{boundary}"

# Build Hamiltonian
hamiltonian = build_heisenberg_hamiltonian(num_qubits, J, h, boundary)

# Display information
print(f"Isotropic Heisenberg Hamiltonian: {{num_qubits}} qubits")
print(f"Exchange coupling: J={{J}} (isotropic)")
print(f"Magnetic field: h={{h}} (longitudinal)")
print(f"Boundary conditions: {{boundary}}")
print(f"Total Pauli terms: {{len(hamiltonian.paulis)}}")
'''
        
        return code
    

# æµ‹è¯•ä»£ç 
if __name__ == "__main__":
    print("ğŸ§ª Testing Simplified HeisenbergHamiltonianBuilder...")
    
    try:
        builder = HeisenbergHamiltonianBuilder()
        
        print(f"ğŸ“‹ Component: {builder.get_component_name()}")
        print(f"ğŸ“‹ Description: {builder.get_description()}")
        
        # ç®€åŒ–çš„æµ‹è¯•ç”¨ä¾‹ - åªæµ‹è¯•å„å‘åŒæ€§æ¨¡å‹
        test_cases = [
            {
                "name": "Basic isotropic Heisenberg",
                "params": {
                    "num_qubits": 4, 
                    "J": 1.0,
                    "h": 0.0,
                    "boundary_conditions": "open"
                }
            },
            {
                "name": "Ferromagnetic with field",
                "params": {
                    "num_qubits": 6,
                    "J": 1.5,
                    "h": 0.5,
                    "boundary_conditions": "open"
                }
            },
            {
                "name": "Antiferromagnetic ring",
                "params": {
                    "num_qubits": 6,
                    "J": -1.0,
                    "h": 0.0,
                    "boundary_conditions": "periodic"
                }
            },
            {
                "name": "Benchmark-style parameters",
                "params": {
                    "num_qubits": 4,
                    "J": 2.0,
                    "h": 0.8,
                    "boundary_conditions": "open"
                }
            }
        ]
        
        for i, test_case in enumerate(test_cases, 1):
            print(f"\nğŸ§ª Test Case {i}: {test_case['name']}")
            print(f"  Parameters: {test_case['params']}")
            
            result = builder.execute("test query", test_case['params'])
            print(f"  âœ… Notes: {result['notes']}")
            print(f"  ğŸ“ Code length: {len(result['code'])} chars")
            
            # éªŒè¯ç”Ÿæˆçš„ä»£ç æ˜¯å¦åŒ…å«å…³é”®ç»„ä»¶
            code = result['code']
            assert "build_heisenberg_hamiltonian" in code
            assert "SparsePauliOp" in code
            assert "Isotropic" in code
        
        print(f"\nâœ… All simplified HeisenbergHamiltonianBuilder tests passed!")
        print(f"ğŸ¯ Simplified component features:")
        print(f"  â€¢ Focus on isotropic Heisenberg model only (Jx=Jy=Jz=J)")
        print(f"  â€¢ Simplified parameter interface (J, h, boundary)")
        print(f"  â€¢ Longitudinal magnetic field support (Z direction)")
        print(f"  â€¢ Open and periodic boundary conditions")
        print(f"  â€¢ Clean and maintainable code generation")
        print(f"  â€¢ Reduced complexity while maintaining full functionality")
        
    except Exception as e:
        print(f"âš ï¸ HeisenbergHamiltonianBuilder test error: {e}")
        import traceback
        traceback.print_exc()